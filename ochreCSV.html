<!DOCTYPE html>
<html>

<head>
  <script>
    function loadXMLDoc(filename) {
      if (window.ActiveXObject) {
        xhttp = new ActiveXObject("Msxml2.XMLHTTP");
      }
      else {
        xhttp = new XMLHttpRequest();
      }
      xhttp.open("GET", filename, false);
      try { xhttp.responseType = "msxml-document" } catch (err) { } // Helping IE11
      xhttp.send("");
      return xhttp.responseXML;
    }

    function displayResult() {
      //The uuid value comes from the button click ID.
      xml = loadXMLDoc("http://ochre.lib.uchicago.edu/ochre?uuid="+uuid);
      xsl = loadXMLDoc("http://ochre.lib.uchicago.edu/ochre/ochre_csv.xsl");
      // code for IE
      if (window.ActiveXObject || xhttp.responseType == "msxml-document") {
        ex = xml.transformNode(xsl);
        document.getElementById("tblexportData").innerHTML = ex;
      }
      // code for Chrome, Firefox, Opera, etc.
      else if (document.implementation && document.implementation.createDocument) {
        xsltProcessor = new XSLTProcessor();
        xsltProcessor.importStylesheet(xsl);
        resultDocument = xsltProcessor.transformToFragment(xml, document);
        document.getElementById("tblexportData").appendChild(resultDocument);
      }
    }

    //Code used to download div to CSV

      function exportToCSV(filename = '') {
        var downloadurl;
        var dataFileType = 'text/csv';
        var rawData = document.getElementById("tblexportData");
        var csvData = rawData.innerHTML;

        // Specify file name
        filename = filename ? filename + '.csv' : 'export_ochre_data.csv';
        // Create download link element
        downloadurl = document.createElement("a");

        document.body.appendChild(downloadurl);

        if (navigator.msSaveOrOpenBlob) {
          var blob = new Blob(['\ufeff', csvData], {
            type: dataFileType
          });
          navigator.msSaveOrOpenBlob(blob, filename);
        } else {
          // Create a link to the file
          downloadurl.href = 'data:' + dataFileType + ', ' + csvData;

          // Setting the file name
          downloadurl.download = filename;

          //triggering the function
          downloadurl.click();
        }
        window.close();
      }

  </script>
</head>
<body onload="displayResult()">
  <div>
    <div>
      <h2>The file has been formatted for download.</h2>
      <button onclick="exportToCSV()">Save As Tab-Delimited CSV File</button>
      <h2>Disable pop-up blocker to allow downloads from this page.</h2>
      <p>Note: if the columns do not align correctly, then import/open as tab-separated.</p>
    </div>
    <div style="display: none;" id="tblexportData"/>
  </div>
</body>
</html>
